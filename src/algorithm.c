#include "algorithm.h"
#include "binary.h"
#include <stdint.h>

static const uint8_t PC1[56] = {
	0x39, 0x31, 0x29, 0x21, 0x19, 0x11, 0x09,
	0x01, 0x3A, 0x32, 0x2A, 0x22, 0x1A, 0x12,
	0x0A, 0x02, 0x3B, 0x33, 0x2B, 0x23, 0x1B,
	0x13, 0x0B, 0x03, 0x3C, 0x34, 0x2C, 0x24,
	0x3F, 0x37, 0x2F, 0x27, 0x1F, 0x17, 0x0F,
	0x07, 0x3E, 0x36, 0x2E, 0x26, 0x1E, 0x16,
	0x0E, 0x06, 0x3D, 0x35, 0x2D, 0x25, 0x1D,
	0x15, 0x0D, 0x05, 0x1C, 0x14, 0x0C, 0x04
};

static const uint8_t PC2[48] = {
	0x0E, 0x11, 0x0B, 0x18, 0x01, 0x05,
	0x03, 0x1C, 0x0F, 0x06, 0x15, 0x0A,
	0x17, 0x13, 0x0C, 0x04, 0x1A, 0x08,
	0x10, 0x07, 0x1B, 0x14, 0x0D, 0x02,
	0x29, 0x34, 0x1F, 0x25, 0x2F, 0x37,
	0x1E, 0x28, 0x33, 0x2D, 0x21, 0x30,
	0x2B, 0x31, 0x27, 0x38, 0x22, 0x35,
	0x2E, 0x2A, 0x32, 0x24, 0x1D, 0x20
};

static const uint8_t IP[64] = {
	0x3A, 0x32, 0x2A, 0x22, 0x1A, 0x12, 0x0A, 0x02,
	0x3C, 0x34, 0x2C, 0x24, 0x1C, 0x14, 0x0C, 0x04,
	0x3E, 0x36, 0x2E, 0x26, 0x1E, 0x16, 0x0E, 0x06,
	0x40, 0x38, 0x30, 0x28, 0x20, 0x18, 0x10, 0x08,
	0x39, 0x31, 0x29, 0x21, 0x19, 0x11, 0x09, 0x01,
	0x3B, 0x33, 0x2B, 0x23, 0x1B, 0x13, 0x0B, 0x03,
	0x3D, 0x35, 0x2D, 0x25, 0x1D, 0x15, 0x0D, 0x05,
	0x3F, 0x37, 0x2F, 0x27, 0x1F, 0x17, 0x0F, 0x07
};

static const uint8_t E[48] = {
	0x20, 0x01, 0x02, 0x03, 0x04, 0x05,
	0x04, 0x05, 0x06, 0x07, 0x08, 0x09,
	0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D,
	0x0C, 0x0D, 0x0E, 0x0F, 0x10, 0x11,
	0x10, 0x11, 0x12, 0x13, 0x14, 0x15,
	0x14, 0x15, 0x16, 0x17, 0x18, 0x19,
	0x18, 0x19, 0x1A, 0x1B, 0x1C, 0x1D,
	0x1C, 0x1D, 0x1E, 0x1F, 0x20, 0x01
};

static const uint8_t S1[64] = {
	0xE, 0x4, 0xD, 0x1, 0x2, 0xF, 0xB, 0x8, 0x3, 0xA, 0x6, 0xC, 0x5, 0x9, 0x0, 0x7,
	0x0, 0xF, 0x7, 0x4, 0xE, 0x2, 0xD, 0x1, 0xA, 0x6, 0xC, 0xB, 0x9, 0x5, 0x3, 0x8,
	0x4, 0x1, 0xE, 0x8, 0xC, 0x6, 0x2, 0xB, 0xF, 0xC, 0x9, 0x7, 0x3, 0xA, 0x5, 0x0,
	0xF, 0xC, 0x8, 0x2, 0x4, 0x9, 0x1, 0x7, 0x5, 0xB, 0x3, 0xE, 0xA, 0x0, 0x6, 0xD
};

static const uint8_t S2[64] = {
	0xF, 0x1, 0x8, 0xE, 0x6, 0xB, 0x3, 0x4, 0x9, 0x7, 0x2, 0xD, 0xC, 0x0, 0x5, 0xA,
	0x3, 0xD, 0x4, 0x7, 0xF, 0x2, 0x8, 0xE, 0xC, 0x0, 0x1, 0xA, 0x6, 0x9, 0xB, 0x5,
	0x0, 0xE, 0x7, 0xB, 0xA, 0x4, 0xD, 0x1, 0x5, 0x8, 0xC, 0x6, 0x9, 0x3, 0x2, 0xF,
	0xD, 0x8, 0xA, 0x1, 0x3, 0xF, 0x4, 0x2, 0xB, 0x6, 0x7, 0xC, 0x0, 0x5, 0xE, 0x9
};

static const uint8_t S3[64] = {
	0xA, 0x0, 0x9, 0xE, 0x6, 0x3, 0xF, 0x5, 0x1, 0xD, 0xC, 0x7, 0xB, 0x4, 0x2, 0x8,
	0xD, 0x7, 0x0, 0x9, 0x3, 0x4, 0x6, 0xA, 0x2, 0x8, 0x5, 0xE, 0xC, 0xB, 0xF, 0x1,
	0xD, 0x6, 0x4, 0x9, 0x8, 0xF, 0x3, 0x0, 0xB, 0x1, 0x2, 0xC, 0x5, 0xA, 0xE, 0x7,
	0x1, 0xA, 0xD, 0x0, 0x6, 0x9, 0x8, 0x7, 0x4, 0xF, 0xE, 0x3, 0xB, 0x6, 0x2, 0xC
};

static const uint8_t S4[64] = {
	0x7, 0xD, 0xE, 0x3, 0x0, 0x6, 0x9, 0xA, 0x1, 0x2, 0x8, 0x5, 0xB, 0xC, 0x4, 0xF,
	0xD, 0x8, 0xB, 0x5, 0x6, 0xF, 0x0, 0x3, 0x4, 0x7, 0x2, 0xC, 0x1, 0xA, 0xE, 0x9,
	0xA, 0x6, 0x9, 0x0, 0xC, 0xB, 0x7, 0xD, 0xF, 0x1, 0x3, 0xE, 0x5, 0x2, 0x8, 0x4,
	0x3, 0xF, 0x0, 0x6, 0xA, 0x1, 0xD, 0x8, 0x9, 0x4, 0x5, 0xB, 0xC, 0x7, 0x2, 0xE
};

static const uint8_t S5[64] = {
	0x2, 0xC, 0x4, 0x1, 0x7, 0xA, 0xB, 0x6, 0x8, 0x5, 0x3, 0xF, 0xD, 0x0, 0xE, 0x9,
	0xE, 0xB, 0x2, 0xC, 0x4, 0x7, 0xD, 0x1, 0x5, 0x0, 0xF, 0xA, 0x3, 0x9, 0x8, 0x6,
	0x4, 0x2, 0x1, 0xB, 0xA, 0xD, 0x7, 0x8, 0xF, 0x9, 0xC, 0x5, 0x6, 0x3, 0x0, 0xE,
	0xB, 0x8, 0xC, 0x7, 0x1, 0xE, 0x2, 0xD, 0x6, 0xF, 0x0, 0x9, 0xA, 0x4, 0x5, 0x3
};

static const uint8_t S6[64] = {
	0xC, 0x1, 0xA, 0xF, 0x9, 0x2, 0x6, 0x8, 0x0, 0xD, 0x3, 0x4, 0xE, 0x7, 0x5, 0xB,
	0xA, 0xF, 0x4, 0x2, 0x7, 0xC, 0x9, 0x5, 0x6, 0x1, 0xD, 0xE, 0x0, 0xB, 0x3, 0x8,
	0x9, 0xE, 0xF, 0x5, 0x2, 0x8, 0xC, 0x3, 0x7, 0x0, 0x4, 0xA, 0x1, 0xD, 0xB, 0x6,
	0x4, 0x3, 0x2, 0xC, 0x9, 0x5, 0xF, 0xA, 0xB, 0xE, 0x1, 0x7, 0x6, 0x0, 0x7, 0xD
};

static const uint8_t S7[64] = {
	0x4, 0xB, 0x2, 0xE, 0xF, 0x0, 0x8, 0xD, 0x3, 0xC, 0x9, 0x7, 0x5, 0xA, 0x6, 0x1,
	0xD, 0x0, 0xB, 0x7, 0x4, 0x9, 0x1, 0xA, 0xE, 0x3, 0x5, 0xC, 0x2, 0xF, 0x8, 0x6,
	0x1, 0x4, 0xB, 0xD, 0xC, 0x3, 0x7, 0xE, 0xA, 0xF, 0x6, 0x8, 0x0, 0x5, 0x9, 0x2,
	0x6, 0xB, 0xD, 0x8, 0x1, 0x4, 0xA, 0x7, 0x9, 0x5, 0x0, 0xF, 0xE, 0x2, 0x3, 0xC
};

static const uint8_t S8[64] = {
	0xD, 0x2, 0x8, 0x4, 0x6, 0xF, 0xB, 0x1, 0xA, 0x9, 0x3, 0xE, 0x5, 0x0, 0xC, 0x7,
	0x1, 0xF, 0xD, 0x8, 0xA, 0x3, 0x7, 0x4, 0xC, 0x5, 0x6, 0xB, 0x0, 0xE, 0x9, 0x2,
	0x7, 0xB, 0x4, 0x1, 0x9, 0xC, 0xE, 0x2, 0x0, 0x6, 0xA, 0xD, 0xF, 0x3, 0x5, 0x8,
	0x2, 0x1, 0xE, 0x7, 0x4, 0xA, 0x8, 0xD, 0xF, 0xC, 0x9, 0x0, 0x3, 0x5, 0x6, 0xB
};

static uint64_t permutedkey(uint64_t key)
{
	uint64_t ret = 0;
	for (size_t i = 0; i < 56; i++) {
		if (GETBIT64(key, PC1[i]))
			SETBIT56(ret, i + 1);
	}
	return ret;
}

static uint64_t ip(uint64_t message)
{
	uint64_t ret = 0;
	for (size_t i = 0; i < 64; i++) {
		if (GETBIT64(message, IP[i]))
			SETBIT64(ret, i + 1);
	}
	return ret;
}

static void genkeys(uint64_t key, uint64_t *keys)
{
	uint32_t c0 = key >> 28;
	uint32_t d0 = key & 0xFFFFFFF;

	for (size_t i = 0; i < 16; i++) {
		size_t shift = 2;
		if (i == 0 || i == 1 || i == 8 || i == 15)
			shift = 1;

		c0 = ROL28(c0, shift);
		d0 = ROL28(d0, shift);

		uint64_t cndn = COMBO28(c0, d0);
		uint64_t kn = 0;
		for (size_t j = 0; j < 48; j++) {
			if (GETBIT56(cndn, PC2[j]))
				SETBIT48(kn, j + 1);
		}

		keys[i] = kn;
	}
}

static uint64_t f(uint32_t r, uint64_t k)
{
	uint64_t e = 0;
	for (size_t i = 0; i < 48; i++) {
		if (GETBIT32(r, E[i]))
			SETBIT48(e, i + 1);
	}

	return 0x00;
}

uint64_t desencode(uint64_t key, uint64_t message)
{
	uint64_t k[16];
	uint64_t p = permutedkey(key);
	genkeys(p, k);
	uint64_t mip = ip(message);

	uint32_t l0 = mip >> 32;
	uint32_t r0 = mip & 0xFFFFFFFF;
	uint32_t ln;
	uint32_t rn;

	for (size_t i = 0; i < 16; i++) {
		ln = r0;
		rn = l0 ^ f(ln, k[i]);
	}

	return 0x00;
}
